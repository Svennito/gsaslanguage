#!/bin/bash
# 
# gsas_plot_3D - plot all .dat files in a folder in 3D and produce gnuplot script for modifications
#
# (C) Sven Vogel, sven@lanl.gov
#
# call
#
# gsas_plot_3D  <extra_data> <bank>
#
# use second column in CSV file with first column=filename as 1st axis (first axis is d-spacing or whatever is used in gsas_export_plot)

if [ -f "$1" ]; then
  echo "Using CSV file <$1> to extract 2nd axis"
else
  echo "Please provide filename for CSV file with first column=filename of gda files and second column as value for 1st axis, e.g. time or temperature"
  read -p "Please change script and call again"
  exit
fi

if [ "$2" == "" ]; then
  echo "Please provide bank number as second parameter."
  read -p "Please change script and call again"
  exit
fi

# delete previous 3D data files
rm plot3d_intensity.dat
rm plot3d_fit.dat

# get the data
for file in `ls plot_*_bank_$2.dat`; do
  echo ""
  echo "Processing file <$file>..."
  
  # reconstruct filename of GDA file
  let length=${#file}-16
  exp_file=${file:5:$length}
  echo "- original EXP filename was <$exp_file.EXP>"
  
  # find value for first axis in file
  grep -i $exp_file $1 > /dev/null
  if [ $? -eq 0 ]; then
    # we found it
    first_col_val=`grep -i $exp_file $1 | awk -F, '{ print $2 }'`
    if [ "$first_col_val" == "" ]; then
      read -p "Did not find value for first axis in $1 for $exp_file! Cannot work, please fix"
      exit
    else
      echo "- found value <$first_col_val> for refinement of <$exp_file>."
    fi
  else
    # we did not find it.
    read -p "Did not find line for $exp_file in $1! Cannot work, please fix"
    exit
  fi
  
  # add the x-axis column (d-spacing or so) and intensity column from the data file 
  echo "NR>6 { print \$2, $first_col_val, \$3 }" > temp.awk
  cat $file | awk -f temp.awk >> plot3d_intensity.dat
  echo "- added measured intensity to <plot3d_intensity.dat>"
  echo "NR>6 { print \$2, $first_col_val, \$4 }" > temp.awk
  cat $file | awk -f temp.awk >> plot3d_fit.dat
  echo "- added fit intensity to <plot3d_fit.dat>"
  
  # add empty lines to tell gnuplot where a new line starts
  echo "">> plot3d_intensity.dat
  echo "">> plot3d_fit.dat  
done

echo ""
echo "Added all experimental intensity data to <plot3d_intensity.dat>."
echo "Added all fit intensity data to <plot3d_fit.dat>."

echo "# Gnuplot script generated by Sven Vogel's gsas_plot_3D" > plot3d_intensity.plt
echo "set terminal pngcairo size 1920,1024 enhanced color font 'Verdana,10'" >> plot3d_intensity.plt
echo "" >> plot3d_intensity.plt
echo "load 'moreland.pal'" >> plot3d_intensity.plt
echo "" >> plot3d_intensity.plt
echo "# setting axis labels" >> plot3d_intensity.plt
echo "set xlabel 'd-spacing [A]'" >> plot3d_intensity.plt
echo "set ylabel 'Days since start' rotate parallel offset -8,0" >> plot3d_intensity.plt
echo "set zlabel 'Intensity' offset 0,0 rotate parallel" >> plot3d_intensity.plt
echo "" >> plot3d_intensity.plt
echo "# setting ranges for the axis" >> plot3d_intensity.plt
echo "set xrange [1:3]" >> plot3d_intensity.plt
echo "set yrange []" >> plot3d_intensity.plt
echo "set zrange []" >> plot3d_intensity.plt
echo "" >> plot3d_intensity.plt
echo "# turn on surface plot and contour blot below" >> plot3d_intensity.plt
echo "set pm3d at sb" >> plot3d_intensity.plt
echo "set hidden3d" >> plot3d_intensity.plt
echo "" >> plot3d_intensity.plt
echo "# setting the view point" >> plot3d_intensity.plt
echo "set view 75,0,1,1" >> plot3d_intensity.plt
echo "" >> plot3d_intensity.plt
echo "# and plot..." >> plot3d_intensity.plt
echo "set output 'plot3d_map_and_contour.png'" >> plot3d_intensity.plt
echo "splot 'plot3d_intensity.dat' ti 'Experimental Intensity'" >> plot3d_intensity.plt
echo "" >> plot3d_intensity.plt
echo "# and plot map only..." >> plot3d_intensity.plt
echo "set pm3d map" >> plot3d_intensity.plt
echo "set zlabel ''" >> plot3d_intensity.plt
echo "set ylabel 'Days since start' rotate parallel offset -7,0" >> plot3d_intensity.plt
echo "set view 0,0,1,1" >> plot3d_intensity.plt
echo "unset ztics" >> plot3d_intensity.plt
echo "set xlabel 'd-spacing [A]' offset 0,5" >> plot3d_intensity.plt
echo "set output 'plot3d_map_only.png'" >> plot3d_intensity.plt
echo "splot 'plot3d_intensity.dat' ti 'Experimental Intensity'" >> plot3d_intensity.plt

echo "Wrote gnuplot plotting script to <plot3d_intensity.plt>."
echo "Executing gnuplot..."
gnuplot < plot3d_intensity.plt
echo "Unless error mesages occured, files <plot3d_map_only.png> and <plot3d_map_and_contour.png> were created."



