# Called when analysis is done

# Produce plot of CHISQ evolotion
echo 'set xtics rotate by -15' > temp.plt
echo 'set xrange [0:*]' >> temp.plt
echo 'set logscale y' >> temp.plt
echo 'set xlabel "Rietveld cycle"' >> temp.plt
echo 'set ylabel "Reduced CHISQ"' >> temp.plt
echo 'set y2label "Number of variables"' >> temp.plt
echo 'set yrange [0.1:*]' >> temp.plt
echo 'set y2range [0:*]' >> temp.plt
echo 'set y2tics border' >> temp.plt
echo 'set ytics nomirror' >> temp.plt
echo 'set key outside below' >> temp.plt
echo 'set output "Reduced.eps"' >> temp.plt
echo 'set terminal postscript eps enhanced color 24' >> temp.plt
echo 'plot \' >> temp.plt
echo '   "< grep Reduced `cat GSAS_EXP`.LST" using 4  title "Reduced CHISQ",\' >> temp.plt
echo '   "< grep Reduced `cat GSAS_EXP`.LST" using 6  axes x1y2 title "Number of variables"' >> temp.plt
gnuplot temp.plt

# generate plot with shift evolution
echo 'set xtics rotate by -15' > temp.plt
echo 'set xrange [0:*]' >> temp.plt
echo 'set logscale y' >> temp.plt
echo 'set xlabel "Rietveld cycle"' >> temp.plt
echo 'set ylabel "Final variable sum((shift/esd)**2)"' >> temp.plt
echo 'set y2label "CPU time/cycle [s]"' >> temp.plt
echo 'set y2range [0:*]' >> temp.plt
echo 'set y2tics border' >> temp.plt
echo 'set key outside below' >> temp.plt
echo 'set ytics nomirror' >> temp.plt
echo 'set output "Shift.eps"' >> temp.plt
echo 'set terminal postscript eps enhanced color 24' >> temp.plt
echo 'plot \' >> temp.plt
echo '   "< grep Final `cat GSAS_EXP`.LST" using 7  with lines title "Shift",\' >> temp.plt
echo '   "< grep Final `cat GSAS_EXP`.LST" using 9  axes x1y2 title "CPU time"' >> temp.plt
gnuplot temp.plt

echo "\section{Reduced $\chi^2$ and variable shifts}" >> `cat GSAS_EXP`.tex
echo "\includegraphics[width=150mm]{Reduced.eps}" >> `cat GSAS_EXP`.tex
echo "\newline" >> `cat GSAS_EXP`.tex
echo "\includegraphics[width=150mm]{Shift.eps}" >> `cat GSAS_EXP`.tex

# Produce PDF file with information
echo "\section{Parameters}" >> `cat GSAS_EXP`.tex
echo "The refined parameters and their values and esds are:" >> `cat GSAS_EXP`.tex
echo "\begin{verbatim}" >> `cat GSAS_EXP`.tex
cat `cat GSAS_EXP`.PVE >> `cat GSAS_EXP`.tex
echo "\end{verbatim}" >> `cat GSAS_EXP`.tex
echo "\end{document}" >> `cat GSAS_EXP`.tex
echo "Generating DVI file..."
latex `cat GSAS_EXP`.tex
echo "Generating PDF file..."
dvipdf `cat GSAS_EXP`.dvi
#acroread `cat GSAS_EXP`.pdf

# clean up
rm out.txt
rm temp.txt
rm temp2.txt
rm maxtof.txt
rm maxtof2.txt
rm shift.txt
rm chisq.txt
rm *.EPS
rm `cat GSAS_EXP`.dvi
rm `cat GSAS_EXP`.log
rm `cat GSAS_EXP`.aux
rm `cat GSAS_EXP`.tex
rm `cat GSAS_EXP`.CMT
rm `cat GSAS_EXP`.O??
rm `cat GSAS_EXP`.P[^VE]*
rm `cat GSAS_EXP`.R??
rm gsas_print.txt
rm gsas_step.txt
rm hist.txt
rm nhist.txt
rm powpref
rm powplot
rm genles
rm expedt
rm GSAS_EXP
rm flag.txt
rm Reduced.eps
rm Shift.eps
rm temp.plt