# echo the call so we can see what's going on
echo "$0 $1 $2 $3 $4 $5 $6"

# Check syntax
if [ "$1" = "" ]; then
	echo "$0 called without desired section - assuming Z section!"
fi

# generate the Fourier difference map (this works currently only if no other map was generated)
echo "k f" > temp.txt
echo "DELF" >> temp.txt
if [ "$1" = "" ]; then
  echo "z" >> temp.txt
else 
  echo $1 >> temp.txt
fi  
# no individual step size for the different directions
echo "n">> temp.txt
# step size in A
echo "0.2">> temp.txt
# limits along a, b, and c (do full cell, cut in VESTA)
echo "0 1">> temp.txt
echo "0 1">> temp.txt
echo "0 1">> temp.txt
# get number of histograms so we can include them all
grep NHST `cat GSAS_EXP`.EXP | tail --bytes 67 | head --bytes 2 > nhist.txt
NHIST=`cat nhist.txt`
if [ "$NHIST" = "  " ]; then
	grep NHST `cat GSAS_EXP`.EXP | tail --bytes 67 | head --bytes 3 > nhist.txt
	NHIST=`cat nhist.txt`
fi
echo "We have <$NHIST> histograms in this refinement."
COUNTER=0
while [ $COUNTER -lt $NHIST ]; do
	let COUNTER=COUNTER+1 
	echo $COUNTER >> temp.txt
done
echo "0" >> temp.txt
# add all other maps
echo "a FOBS" >> temp.txt
echo "a FCLC" >> temp.txt
echo "a NFDF" >> temp.txt
echo "2" >> temp.txt
echo "x x" >> temp.txt

expedt `cat GSAS_EXP` < temp.txt > out.txt
fourier `cat GSAS_EXP`
read -p "pause..."
# make input for forplot to convert for VESTA
echo "z e" > temp.txt
echo "DELF" >> temp.txt
echo "e" >> temp.txt
echo "f FOBS" >> temp.txt
echo "e" >> temp.txt
echo "f FCLC" >> temp.txt
echo "e" >> temp.txt
echo "f 2FDF" >> temp.txt
echo "e" >> temp.txt
echo "q" >> temp.txt
echo "Creating .grd files for VESTA..."
forplot `cat GSAS_EXP` < temp.txt > out.txt
echo "Done."

# Output stuff to the Latex document.
echo "Generated difference Fourier maps and converted them to a files `cat GSAS_EXP`_DELF.grd, `cat GSAS_EXP`_FOBS.grd, `cat GSAS_EXP`_FCLC.grd, `cat GSAS_EXP`_2FDF.grd." >> `cat GSAS_EXP`.tex
echo "Koichi Momma's software VESTA can read those files, so you can view the " >> `cat GSAS_EXP`.tex
echo "Fourier maps in 3D. You may download VESTA from"  >> `cat GSAS_EXP`.tex
echo "\verb=http://www.geocities.jp/kmo_mma/crystal/en/vesta.html=. Open the grd file in VESTA."  >> `cat GSAS_EXP`.tex
echo "To modify the contour levels in VESTA, go to Objects – Properties – Isosurfaces, select an isosurface in the list (roughly center of the dialog box, next to new, delete and clear buttons) and modify the level, color etc. above the list."  >> `cat GSAS_EXP`.tex
echo "In order to also plot the atoms, go to Edit Data – Structure Parameters and click on import (bottom right) and read the EXP file `cat GSAS_EXP`.EXP with the current crystal structure.\newline" >> `cat GSAS_EXP`.tex
